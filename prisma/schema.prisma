// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String?
  role      Role      @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Profile fields (Sprint 1)
  username    String?   @unique  // @handle for public profile
  displayName String?            // Display name (can differ from name)
  bio         String?            // Short bio
  avatarUrl   String?            // Profile picture URL
  studioName  String?            // Studio/team name
  website     String?            // Personal/studio website
  twitter     String?            // Twitter handle
  discord     String?            // Discord username
  
  projects  Project[]
  following ProjectFollower[]
  
  // Feedback relations
  feedbackThreads   FeedbackThread[]  @relation("FeedbackAuthor")
  feedbackVotes     FeedbackVote[]    @relation("FeedbackVoter")
  feedbackComments  FeedbackComment[] @relation("CommentAuthor")
  notifications     Notification[]
  
  // Tester engagement
  testerProfile     TesterProfile?
  testSessions      TestSession[]
}

enum Role {
  USER
  ADMIN
}

enum Visibility {
  PRIVATE   // Only owner can see
  UNLISTED  // Anyone with link can see
  PUBLIC    // Listed in discovery
}

model Project {
  id            String     @id @default(cuid())
  name          String
  subtitle      String?    // Short tagline for SEO meta description (140 chars)
  description   String?    @db.Text  // Rich text description
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Game Hub fields (Sprint 1)
  slug          String?    @unique  // Custom URL slug for public page
  visibility    Visibility @default(PRIVATE)
  bannerUrl     String?              // Banner image for game hub
  logoUrl       String?              // Game logo
  genre         String?              // Primary genre
  tags          String[]   @default([])  // Tags for discovery
  steamUrl      String?              // Steam store link
  itchUrl       String?              // Itch.io link
  websiteUrl    String?              // Game website
  discordUrl    String?              // Discord server invite
  
  // Score tier configuration
  tierLowMax    Int        @default(40)   // 0-40% = low tier
  tierMediumMax Int        @default(70)   // 41-70% = medium tier (71-100% = high)
  tierLowLabel  String     @default("Needs Improvement")
  tierMediumLabel String   @default("Good")
  tierHighLabel String     @default("Excellent")
  tierLowMsg    String?    // Custom message for low scorers
  tierMediumMsg String?    // Custom message for medium scorers  
  tierHighMsg   String?    // Custom message for high scorers
  
  // Game profile content
  rules         String?    @db.Text  // Game rules/how to play (rich text)
  rulesPdfUrl   String?              // PDF link for rules document
  features      String[]   @default([])  // Key features list
  
  stats         Stat[]
  forms         Form[]
  updates       ProjectUpdate[]
  versions      ProjectVersion[]
  elements      PageElement[]
  snapshots     Snapshot[]
  pinnedSections PinnedSection[]
  followers     ProjectFollower[]
  feedbackThreads FeedbackThread[]
  galleryImages GalleryImage[]
  progressBoards ProgressBoard[]
}

// Tracks all updates/changes to the project (like GitHub contributions)
model ProjectUpdate {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        UpdateType
  title       String
  description String?
  metadata    Json?    // Additional data based on type
  createdAt   DateTime @default(now())
}

enum UpdateType {
  VERSION_RELEASE   // New version released
  RULES_UPDATED     // Game rules updated
  SETTINGS_CHANGED  // Settings changed
  FORM_CREATED      // New form created
  FORM_UPDATED      // Form updated
  MEDIA_UPDATED     // Banner/logo updated
  VISIBILITY_CHANGED // Visibility changed
}

// Game versions (like releases)
model ProjectVersion {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  slug        String?  // URL-friendly slug (e.g., "v1-0-new-combat-system")
  version     String   // e.g., "1.0.0", "v2.1"
  title       String   // Version title/name
  description String?  @db.Text  // Brief description of this version
  imageUrl    String?  // Cover image for this version
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  page        VersionPage?

  @@unique([projectId, slug])
}

// Version page content (full page builder data)
model VersionPage {
  id          String   @id @default(cuid())
  versionId   String   @unique
  version     ProjectVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  content     Json     // Full page structure (rows, columns, elements)
  settings    Json?    // Page settings (theme, fonts, colors)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Reusable elements library (heroes, items, cards, etc.)
model PageElement {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String   // "Phantom Assassin", "Fire Dragon"
  type        String   // hero, item, ability, card, custom
  category    String?  // For grouping in picker
  data        Json     // Element content/stats
  thumbnail   String?  // Preview image
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Stat {
  id          String     @id @default(cuid())
  name        String
  description String?
  minValue    Int        @default(1)
  maxValue    Int        @default(10)
  category    String?    // Category grouping: gameplay, visuals, audio, balance, progression, multiplayer, overall
  weight      Float      @default(1.0)  // Weight multiplier for category scoring
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  questions   Question[]
}

model Form {
  id                 String     @id @default(cuid())
  slug               String?    @unique  // Custom URL slug (optional)
  title              String
  description        String?
  isActive           Boolean    @default(false)
  // Landing page fields
  landingTitle       String?    // Main headline for landing page
  landingSubtitle    String?    // Supporting text
  landingDescription String?    // Detailed description
  landingImage       String?    // Cover image URL
  ctaText            String     @default("Start Quiz")  // Call-to-action button text
  themeColor         String     @default("#8b5cf6")     // Primary theme color (purple default)
  // Results display settings
  showCategoryScores Boolean    @default(true)   // Show category breakdown on results
  showOverallScore   Boolean    @default(true)   // Show overall score on results
  showComparison     Boolean    @default(false)  // Show "your score vs average"
  projectId          String
  project            Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  questions          Question[]
  responses          Response[]
}

model Question {
  id           String       @id @default(cuid())
  formId       String
  form         Form         @relation(fields: [formId], references: [id], onDelete: Cascade)
  statId       String?      // Optional - some question types may not have a direct stat
  stat         Stat?        @relation(fields: [statId], references: [id], onDelete: Cascade)
  questionText String       // The actual question text
  type         QuestionType @default(SLIDER)
  options      Json?        // For multiple choice: [{text: "Option A", points: 10, statId?: "..."}, ...]
  minValue     Int          @default(1)   // For slider type
  maxValue     Int          @default(10)  // For slider type
  order        Int          @default(0)
  createdAt    DateTime     @default(now())
  answers      Answer[]
}

enum QuestionType {
  SLIDER          // Rate on a scale (1-10)
  STAR_RATING     // Rate with 1-5 stars
  NPS             // Net Promoter Score (0-10)
  YES_NO          // Yes/No/Maybe
  MULTIPLE_SINGLE // Multiple choice, pick one
  MULTIPLE_MULTI  // Multiple choice, pick many
  TEXT_RATING     // Open text + rate the stat
}

model Response {
  id              String   @id @default(cuid())
  formId          String
  form            Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  comment         String?
  respondent      String?
  respondentEmail String?
  createdAt       DateTime @default(now())
  answers         Answer[]
  testSession     TestSession?
}

model Answer {
  id          String   @id @default(cuid())
  responseId  String
  response    Response @relation(fields: [responseId], references: [id], onDelete: Cascade)
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  value       Int?     // Numeric value (for slider, yes/no points, selected option points)
  textValue   String?  // Text value (for open text questions)
  selectedIds Json?    // For multi-select: array of selected option indices
  createdAt   DateTime @default(now())
}

// Analytics Snapshots - saved images of analytics sections
model Snapshot {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  formId      String?  // Optional - if snapshot is form-specific
  name        String   // User-defined name for the snapshot
  type        String   // Type of section: "category-scores", "stat-averages", "response-trend", "overall-score", "insights"
  imageData   String   @db.Text // Base64 WebP image data
  metadata    Json?    // Captured data at snapshot time (for reference)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  pinnedSection PinnedSection?
}

// Pinned sections on Game Page - snapshots or analytics widgets
model PinnedSection {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type        PinnedType
  title       String?  // Optional custom title
  order       Int      @default(0) // For drag & drop ordering
  
  // For snapshot type
  snapshotId  String?  @unique
  snapshot    Snapshot? @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  
  // For analytics widget type
  widgetType  String?  // "fun-score", "response-count", "trend-chart", etc.
  widgetConfig Json?   // Widget-specific configuration
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum PinnedType {
  SNAPSHOT    // Static image from analytics
  ANALYTICS   // Live analytics widget
}

// Project followers - users following a project for updates
model ProjectFollower {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([projectId, userId])
}

// Feedback system - threaded voting for feature requests
model FeedbackThread {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("FeedbackAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  @db.Text
  type        FeedbackType @default(FEATURE)
  status      FeedbackStatus @default(OPEN)
  isEdited    Boolean  @default(false)
  
  votes       FeedbackVote[]
  comments    FeedbackComment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FeedbackVote {
  id          String   @id @default(cuid())
  threadId    String
  thread      FeedbackThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("FeedbackVoter", fields: [userId], references: [id], onDelete: Cascade)
  value       Int      // +1 (upvote) or -1 (downvote)
  createdAt   DateTime @default(now())

  @@unique([threadId, userId])
}

model FeedbackComment {
  id          String   @id @default(cuid())
  threadId    String
  thread      FeedbackThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  content     String   @db.Text
  isEdited    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Notifications for users
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  link        String?  // URL to navigate to
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}

enum FeedbackType {
  FEATURE      // Feature request
  BUG          // Bug report
  IMPROVEMENT  // Improvement suggestion
  OTHER        // Other feedback
}

enum FeedbackStatus {
  OPEN         // New/open
  IN_PROGRESS  // Being worked on
  COMPLETED    // Done
  DECLINED     // Won't do
}

enum NotificationType {
  FEEDBACK_COMMENT    // Someone commented on your thread
  FEEDBACK_STATUS     // Thread status changed
  FEEDBACK_REPLY      // Reply to thread you participated in
  UPDATE_PUBLISHED    // New update published on a game you follow
  FORM_RELEASED       // New form released on a game you follow
}

// Gallery images for project showcase
model GalleryImage {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  imageUrl    String   // URL to the uploaded image
  title       String?  // Optional title/caption
  description String?  // Optional description
  order       Int      @default(0) // For ordering images
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Progress Board - shareable live dashboard for tracking game progress
model ProgressBoard {
  id          String     @id @default(cuid())
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String     // Board name (e.g., "Public Progress", "Investor Dashboard")
  shareToken  String     @unique @default(cuid()) // Unique token for public sharing
  visibility  Visibility @default(PRIVATE)
  
  // Configuration
  columns     Json       // Array of column configs: [{statId, label, showDelta}]
  showTrend   Boolean    @default(true)  // Show trend chart
  showTable   Boolean    @default(true)  // Show version comparison table
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Tester Profile - gamification for playtesters
model TesterProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  xp          Int      @default(0)      // Total XP earned
  level       Int      @default(1)      // Current level
  badges      Json     @default("[]")   // Array of earned badge IDs
  
  // Stats
  testsCompleted  Int  @default(0)      // Total playtests completed
  gamesHelped     Int  @default(0)      // Unique games tested
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Test Session - tracks when a user completes a playtest
model TestSession {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  responseId  String   @unique
  response    Response @relation(fields: [responseId], references: [id], onDelete: Cascade)
  projectId   String
  
  xpEarned    Int      @default(10)     // XP earned for this test
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([projectId])
}
